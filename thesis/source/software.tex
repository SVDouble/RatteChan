% !TeX spellcheck = en_US


\chapter{Control Algorithms}


\section{Overview}

The goal of the whisker control is to reconstruct the contour of an object the whisker came into contact by swiping along its curve.
This requires an algorithm with the following properties:
\begin{enumerate}
    \item It enables the whisker to precisely reconstruct the contour of the object at the immediate contact point.
    \item It can accurately follow the curves and sharp angles of the object, while maintaining the optimal whisker deflection.
    \item It can handle whisker detachment due to sharp angles or sudden changes in the object's surface.
    \item It is aware of the dimensions of the platform and can avoid collisions with the object.
\end{enumerate}

To realize these properties, the control algorithm is implemented as a finite state machine.
Different states handle semantically different aspects of the whisker's behavior.
The behavior of the control is divided into policies that are executed sequentially based on the environment's state.
In this thesis, three policies are implemented:
\begin{enumerate}
    \item \textbf{Swiping Policy:} The whisker is swiping along a smooth curve, maintaining an optimal deflection profile.
    \item \textbf{Retrieval Policy:} The whisker quickly retrieves the object if it has become detached and continues swiping along the profile.
    \item \textbf{Tunnelling Policy:} Given two walls, shaped like a tunnel, the platform maintains centering between the walls.
\end{enumerate}


\section{Data Preprocessing}

\subsection{Control Algorithm Variables}

It is necessary to consider the variables of the control algorithm.
The inputs come from 3 sources:
\begin{enumerate}
    \item Sensors on the platform (provide the platform's position, orientation and whisker deflection).
    \item The geometric configuration of the model (e.g., whisker placement).
    \item The control algorithm's configuration (e.g., whisker deflection threshold).
\end{enumerate}
The output variables concerns the target linear and angular velocities of the platform.
The variables are summarized in Table~\ref{tab:variables}.

\newcommand{\branch}[3]{%
    \scalebox{0.75}{$\left\{
                         \begin{array}{@{}l@{\quad}l@{}}
                             #2, & \text{if } #1,\\[0.5em]
                             #3, & \text{otherwise.}
                         \end{array}
    \right.$}%
}


\begin{table}[htb]
    \centering
    \begin{tabular}{p{1cm} p{2cm} p{3cm} p{8cm}}
        \toprule
        \textbf{Name}                         & \textbf{Values}                                    & \textbf{Source}                                         & \textbf{Description}                                                                                                        \\
        \midrule
        \multicolumn{4}{l}{\textbf{Platform Inputs}} \\
        \midrule
        \(^{\mathrm{w}}\boldsymbol{r}^{t}\)   & \(\mathbb{R}^2, [x, y]^\textrm{T}\)                & Measured                                                & Radius vector in world coordinates.                                                                                         \\
        \(^{\mathrm{w}}\alpha^{t}\)           & \(\mathbb{R}\)                                     & Measured                                                & Yaw angle (orientation) in world coordinates.                                                                               \\
        \(v_{\textrm{total}}\)                & \(\mathbb{R}^{+}\)                                 & Configuration                                           & Total platform velocity.                                                                                                    \\
        \midrule
        \multicolumn{4}{l}{\textbf{Platform Outputs}} \\
        \midrule
        \(^{\mathrm{w}}\boldsymbol{v}^{t}\)   & \(\mathbb{R}^2, [v_x, v_y]^\textrm{T}\)            & Controlled                                              & Linear velocity vector in world coordinates.                                                                                \\
        \(^{\mathrm{w}}\omega^{t}\)           & \(\mathbb{R}^2\)                                   & Controlled                                              & Angular velocity (yaw) in world coordinates.                                                                                \\
        \midrule
        \multicolumn{4}{l}{\textbf{Whisker Inputs (per whisker)}} \\
        \midrule
        \(\delta_{i}^{t}\)                    & \([-\delta_{\textrm{max}},\delta_{\textrm{max}}]\) & Measured                                                & Deflection due to contact forces.                                                                                           \\
        \(\alpha_{i}^{t}\)                    & \(\mathbb{R}\)                                     & \(^{\mathrm{w}}\alpha^{t} + \alpha_{i, \textrm{body}}\) & Yaw angle (orientation) of the whisker base in world coordinates.                                                           \\
        \(orient_{i}^{t}\)                    & \(\{-1, 0, 1\}\)                                   & \(sgn(\delta_{i}^{t}) \cdot side_{i}\)                  & Valid swipe orientation with current deflection: \(-1\) for clockwise, \(0\) for undefined, and \(1\) for counterclockwise. \\
        \(side_{i}\)                          & \(\{-1, 1\}\)                                      & \(\branch{\alpha_{i,\mathrm{body}} < 0}{-1}{1}\)        & Platform side where the whisker is fixed, -1 is left and 1 is right                                                         \\
        \(\delta_{i}^{thr}\)                  & \(\mathbb{R}^{+}\)                                 & Deflection Model                                        & Deflection threshold value for contact detection (\(\delta_{i}^{thr}\ll\delta_{\textrm{max}}\)).                            \\
        \(\delta_{i}^{target}\)               & \([-\delta_{\textrm{max}},\delta_{\textrm{max}}]\) & Deflection Model                                        & Target deflection value for small reconstruction error.                                                                     \\
        \(\boldsymbol{r}_{i, \textrm{body}}\) & \(\mathbb{R}^2\)                                   & Robot Geometry                                          & Offset from the platform center to the whisker base.                                                                        \\
        \(\alpha_{i, \textrm{body}}\)         & \([-\pi,\pi)\)                                     & Robot Geometry                                          & Angle for whisker placement relative to the platform.                                                                       \\
        \bottomrule
    \end{tabular}
    \caption{Overview of input and output variables used in the control system.}
    \label{tab:variables}
\end{table}

\subsection{Deflection Smoothing}
The measured whisker deflection \(\delta_{i}\) is inherently noisy, as whiskers are subject to vibrations and jumps (e.g., due to being temporarily stuck because of the traction).
To smooth the deflection, a Butterworth filter is applied to the deflection values.
It is initially warmed up with the neutral deflection and then updated with each new measurement.


\section{Body Motion Control}
All the control policies calculate the desired body or whisker position, which is then executed by the platform's actuators.
In order for the body to move properly, the body motion algorithm must calculate the required velocities to reach the desired position.
A PID controller is employed to calculate the target platform angular velocity.
To simplify the control, the linear velocity is kept constant, and therefore the velocity vector can be directly derived from the desired angle.
In some cases body motion controller received the target position for the whisker instead of the body.
In this case, the body linear velocity is adjusted for the coordinate transformation from the whisker to the body frame.

Here's the pseudocode for the body motion control algorithm:

\begin{algorithm}[htb]
    \caption{Steer the Platform to Target Position and Orientation}
    \begin{algorithmic}
        \State \textbf{Require} \(^{\mathrm{w}}\boldsymbol{r}^{t+1}\), \(^{\mathrm{w}}\alpha^{t+1}\)
        \State \(^{\mathrm{w}}\omega^{t+1} \gets PID\Big(^{\mathrm{w}}\alpha^{t+1} - ^{\mathrm{w}}\alpha^{t}\Big)\)
        \State \(\boldsymbol{v}^{t+1} \gets v_{\textrm{total}} \cdot \dfrac{^{\mathrm{w}}\boldsymbol{r}^{t+1}}{\|^{\mathrm{w}}\boldsymbol{r}^{t+1}\|}\)
        \State \textbf{Return} \(\boldsymbol{v}^{t+1}\), \(^{\mathrm{w}}\omega^{t+1}\)
    \end{algorithmic}
    \label{alg:steer_platform}
\end{algorithm}

\begin{algorithm}[htb]
    \caption{Steer Whisker to Target Position and Orientation}
    \begin{algorithmic}
        \State \textbf{Require} \(^{\mathrm{w}}\boldsymbol{r}_{wsk}^{t+1}\), \(^{\mathrm{w}}\alpha_{wsk}^{t+1}\)
        \State \((^{\mathrm{w}}\boldsymbol{v}^{t+1},\, ^{\mathrm{w}}\omega^{t+1}) \gets steer\_body\big(^{\mathrm{w}}\boldsymbol{r}_{wsk}^{t+1},\, ^{\mathrm{w}}\alpha_{wsk}^{t+1}\big)\)
        \State \(^{\mathrm{w}}\boldsymbol{r}_{corr} \gets [0,\,0,\,^{\mathrm{w}}\omega^{t+1}] \times \boldsymbol{r}_{wsk, \textrm{body}}\) \Comment{Correct for whisker offset (pivot shift)}
        \State \(^{\mathrm{w}}\boldsymbol{v}^{t+1} \gets v_{\textrm{tot}} \cdot \dfrac{^{\mathrm{w}}\boldsymbol{v}^{t+1} + \,^{\mathrm{w}}\boldsymbol{r}_{corr}}{\|^{\mathrm{w}}\boldsymbol{v}^{t+1} + \,^{\mathrm{w}}\boldsymbol{r}_{corr}\|}\)
        \State \textbf{Return} \(^{\mathrm{w}}\boldsymbol{v}^{t+1}\), \(^{\mathrm{w}}\omega^{t+1}\)
    \end{algorithmic}
    \label{alg:steer_whisker}
\end{algorithm}


\section{Swiping Policy}

The goal of the swiping policy is to provide a smooth swiping motion of the whisker along the object's contour.

\begin{algorithm}[htb]
    \caption{Swiping Policy}
    \begin{algorithmic}
        \State If \(abs(\delta_{wsk}^{t}) < \delta_{wsk}^{threshold}\)  Then
        \State \quad \textbf{Return} \(\;^{\mathrm{w}}\boldsymbol{v}^{t}\), \(\;^{\mathrm{w}}\omega^{t}\)
        \State End If

        \State \(\;^{\mathrm{s}}\boldsymbol{r}_{tip}^{t} \gets defl\_model\Big(\delta_{wsk}^{t}\Big)\)
        \State \(\;^{\mathrm{w}}\boldsymbol{r}_{tip}^{t} \gets \;^{\mathrm{w}}\boldsymbol{r}^{t} + \boldsymbol{r}_{wsk, \textrm{body}} + \;^{\mathrm{s}}\boldsymbol{r}_{tip}^{t}\)
        \State \(spline.add\_keypoint\big(\;^{\mathrm{w}}\boldsymbol{r}_{tip}^{t}\big)\) \Comment{Make sure the spline has the latest tip position}

        \State \(\;^{\mathrm{w}}\boldsymbol{\tau}_{spline}^{t} \gets \dfrac{spline(u_{k1}) - spline(u_{k0})}{\|spline(u_{k1}) - spline(u_{k0})\|}\) \Comment{Spline tangent at the end of the curve}
        \State \(\;^{\mathrm{w}}\theta_{spline}^{t} \gets \arctan2\Big(\;^{\mathrm{w}}\boldsymbol{\tau}_{spline}^{t}\Big)\) \Comment{Spline angle at the end of the curve}
        \State \(\;^{\mathrm{s}}\boldsymbol{r}_{tip}^{target} \gets defl\_model\Big(\delta_{wsk}^{target} \cdot \operatorname{sgn}(\delta_{wsk}^{t})\Big)\) \Comment{Desired whisker base-tip offset}
        \State \(\Delta\boldsymbol{r}_{tip}^{t} \gets rotate\Big(\;^{\mathrm{s}}\boldsymbol{r}_{tip}^{target} - \;^{\mathrm{s}}\boldsymbol{r}_{tip}^{t},\; ^{\mathrm{w}}\alpha_{wsk}^{t}\Big)\) \Comment{\((\forall{t} \;^{\mathrm{w}}\boldsymbol{v}^{t+1} \updownarrow \Delta\boldsymbol{r}_{tip}^{t}) \implies \delta_{wsk}^{t} \xrightarrow[t \to \infty]{} \delta_{wsk}^{target}\) }
        \State \(\;^{\mathrm{s}}\boldsymbol{r}_{tip}^{neutral} \gets defl\_model\Big(0\Big)\) \Comment{Undeformed whisker base-tip offset}
        \State \(w \gets \dfrac{\|\Delta\boldsymbol{r}_{tip}^{t}\|}{\|\;^{\mathrm{s}}\boldsymbol{r}_{tip}^{target} - \;^{\mathrm{s}}\boldsymbol{r}_{tip}^{neutral}\|}\) \Comment{Balance between following the object curvature...}
        \State \(\;^{\mathrm{w}}\boldsymbol{r}_{wsk}^{t+1} \gets \;^{\mathrm{w}}\boldsymbol{r}_{wsk}^{t} + w \cdot \dfrac{-\Delta\boldsymbol{r}_{tip}^{t}}{\|\Delta\boldsymbol{r}_{tip}^{t}\|} + (1 - w) \cdot \;^{\mathrm{w}}\boldsymbol{\tau}_{spline}^{t}\) \Comment{...and maintaining target deflection}
        \State \(\;^{\mathrm{w}}\boldsymbol{v}^{t+1}, \;^{\mathrm{w}}\omega^{t+1} \gets steer\_wsk\big(\;^{\mathrm{w}}\boldsymbol{r}_{wsk}^{t+1},\;^{\mathrm{w}}\theta_{spline}^{t}\big)\)
        \State \textbf{Return} \(\;^{\mathrm{w}}\boldsymbol{v}^{t+1}, \;^{\mathrm{w}}\omega^{t+1}\)
    \end{algorithmic}
    \label{alg:swiping_policy}
\end{algorithm}

\subsection{Contact Detection}


\section{Retrieval Policy}

\subsection{Disengagement Detection}

\subsection{Whisking}

\subsection{Retrieval}


\section{Tunnel Policy}


\section{}
